<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.sevenfs.mapper.project.GanttdMapper">
  
  <!-- 전체 업무 조회 (프로젝트별) -->
  <select id="selectAllTasksByProject" resultType="kr.or.ddit.sevenfs.vo.project.TaskVO" parameterType="int">
    SELECT
      TASK_NO AS taskId,
      TASK_NM AS taskText,
      TASK_BEGIN_DT AS startDate,
      TASK_END_DT AS endDate,
      PROGRSRT AS progress,
      UPPER_TASK_NO AS parentId,
      CHARGER_EMPNO AS owner,
      TASK_STTUS AS status,
      PRIORT AS priority
    FROM PROJECT_TASK
    WHERE PRJCT_NO = #{prjctNo}
    ORDER BY TASK_NO
  </select>

  <!-- 단일 업무 조회 -->
  <select id="selectTaskById" resultType="kr.or.ddit.sevenfs.vo.project.TaskVO" parameterType="long">
    SELECT
      TASK_NO AS taskId,
      TASK_NM AS taskText,
      TASK_BEGIN_DT AS startDate,
      TASK_END_DT AS endDate,
      PROGRSRT AS progress,
      UPPER_TASK_NO AS parentId,
      CHARGER_EMPNO AS owner,
      TASK_STTUS AS status,
      PRIORT AS priority
    FROM PROJECT_TASK
    WHERE TASK_NO = #{taskId}
  </select>

  <!-- 업무 등록 -->
  <insert id="insertTask" parameterType="kr.or.ddit.sevenfs.vo.project.TaskVO">
    <selectKey resultType="long" keyProperty="taskId" order="BEFORE">
      SELECT PROJECT_TASK_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO PROJECT_TASK (
      TASK_NO, PRJCT_NO, TASK_NM, TASK_BEGIN_DT, TASK_END_DT,
      PROGRSRT, UPPER_TASK_NO, CHARGER_EMPNO, TASK_STTUS, PRIORT
    ) VALUES (
      #{taskId}, #{projectNo}, #{taskText}, #{startDate}, #{endDate},
      #{progress}, #{parentId}, #{owner}, #{status}, #{priority}
    )
  </insert>

  <!-- 업무 수정 -->
  <update id="updateTask" parameterType="kr.or.ddit.sevenfs.vo.project.TaskVO">
    UPDATE PROJECT_TASK
    SET
      TASK_NM = #{taskText},
      TASK_BEGIN_DT = #{startDate},
      TASK_END_DT = #{endDate},
      PROGRSRT = #{progress},
      UPPER_TASK_NO = #{parentId},
      CHARGER_EMPNO = #{owner},
      TASK_STTUS = #{status},
      PRIORT = #{priority}
    WHERE TASK_NO = #{taskId}
  </update>

  <!-- 업무 삭제 -->
  <delete id="deleteTask" parameterType="long">
    DELETE FROM PROJECT_TASK
    WHERE TASK_NO = #{taskId}
  </delete>

  <!-- 링크 전체 조회 -->
  <select id="selectAllLinks" resultType="kr.or.ddit.sevenfs.vo.project.LinkVO">
    SELECT
      TASK_LINK_NO AS linkId,
      TASK_NO AS sourceId,
      TRGT_TASK_NO AS targetId,
      TASK_LINK_TY AS linkType
    FROM TASK_LINK
    ORDER BY TASK_LINK_NO
  </select>

  <!-- 링크 등록 -->
  <insert id="insertLink" parameterType="kr.or.ddit.sevenfs.vo.project.LinkVO">
    <selectKey resultType="long" keyProperty="linkId" order="BEFORE">
      SELECT TASK_LINK_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO TASK_LINK (
      TASK_LINK_NO, TASK_NO, LINK_SN, TRGT_TASK_NO, TASK_LINK_TY
    ) VALUES (
      #{linkId}, #{sourceId}, 1, #{targetId}, #{linkType}
    )
  </insert>

  <!-- 링크 수정 -->
  <update id="updateLink" parameterType="kr.or.ddit.sevenfs.vo.project.LinkVO">
    UPDATE TASK_LINK
    SET
      TASK_NO = #{sourceId},
      TRGT_TASK_NO = #{targetId},
      TASK_LINK_TY = #{linkType}
    WHERE TASK_LINK_NO = #{linkId}
  </update>

  <!-- 링크 삭제 -->
  <delete id="deleteLink" parameterType="long">
    DELETE FROM TASK_LINK
    WHERE TASK_LINK_NO = #{linkId}
  </delete>

  <!-- 링크 단건 조회 -->
  <select id="selectLinkById" parameterType="long" resultType="kr.or.ddit.sevenfs.vo.project.LinkVO">
    SELECT
      TASK_LINK_NO AS linkId,
      TASK_NO AS sourceId,
      TRGT_TASK_NO AS targetId,
      TASK_LINK_TY AS linkType
    FROM TASK_LINK
    WHERE TASK_LINK_NO = #{linkId}
  </select>

</mapper>