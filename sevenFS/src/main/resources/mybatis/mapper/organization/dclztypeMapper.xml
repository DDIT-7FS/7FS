<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.sevenfs.mapper.organization.DclztypeMapper">

<!-- 사원의 근태현황 대분류로 조회  -->
<select id="dclzCnt" parameterType="String" resultMap="dclztypeMap">
	SELECT 
	    DT.EMPL_NO,
	    SUM(CASE WHEN CC.UPPER_CMMN_CODE = '00' THEN 1 ELSE 0 END) AS bad,
	    SUM(CASE WHEN CC.UPPER_CMMN_CODE = '10' THEN 1 ELSE 0 END) AS work,
	    SUM(CASE WHEN CC.UPPER_CMMN_CODE = '20' THEN 1 ELSE 0 END) AS vacation,
	    SUM(CASE WHEN CC.UPPER_CMMN_CODE = '30' THEN 1 ELSE 0 END) AS BUSINESS_TRIP
	FROM  DCLZ_TYPE DT
	    LEFT JOIN COMMON_CODE CC ON DT.DCLZ_CODE = CC.CMMN_CODE
	    WHERE DT.EMPL_NO = #{emplNo}
	    GROUP BY DT.EMPL_NO
</select>

<!-- 사원 출퇴근 현황 목록 조회 -->
<!-- <select id="emplDclzTypeList" parameterType="String" resultType="kr.or.ddit.sevenfs.vo.organization.DclzTypeVO">
	SELECT 
		    EMPL_NO
		   ,DCLZ_NO
		   ,DCLZ_CODE
		   ,DCLZ_BEGIN_DT
		   ,DCLZ_END_DT 
	  FROM DCLZ_TYPE
	 WHERE EMPL_NO = #{emplNo}
       AND DCLZ_CODE = '11'
</select> -->

<!-- 전체 근태현황 조회 -->
<select id="emplDclzTypeList" parameterType="String" resultType="kr.or.ddit.sevenfs.vo.organization.DclzTypeVO">
	SELECT 
		    dt.empl_no
		   ,dt.dclz_no
		   ,dt.dclz_code
		   ,TO_CHAR(dt.dclz_begin_dt, 'HH24:MI:SS') as work_begin_time
		   ,TO_CHAR(dt.dclz_end_dt, 'HH24:MI:SS') as work_end_time
		   ,TO_CHAR(dt.dclz_end_dt, 'YYYY-mm-DD') as work_begin_date
		   ,TO_CHAR(dt.dclz_end_dt, 'YYYY-mm-DD') as work_end_date
           ,cc.cmmn_code_nm
	  FROM dclz_type dt
      RIGHT OUTER JOIN common_code cc ON dt.dclz_code = cc.cmmn_code
	  WHERE cmmn_code_group='ATTEND'
      AND dt.empl_no = #{emplNo}
      ORDER BY dt.dclz_no DESC
</select>

<!-- 사원 근태 갯수 -->
<select id="empDetailDclzTypeCnt" parameterType="String" resultType="kr.or.ddit.sevenfs.vo.organization.DclzTypeDetailVO">
	SELECT  cc.cmmn_code,
	        dt.empl_no,
	        cc.cmmn_code_nm,
	        COUNT(empl_no) AS cnt,
	        cc.upper_cmmn_code
	FROM common_code cc
	LEFT JOIN DCLZ_TYPE dt ON(cc.cmmn_code = dt.dclz_code AND dt.empl_no = #{emplNo})
	WHERE cmmn_code_group='ATTEND'
	GROUP BY cc.cmmn_code_nm, dt.empl_no, cc.upper_cmmn_code, cc.cmmn_code
	ORDER BY cc.cmmn_code	
</select>

<resultMap type="kr.or.ddit.sevenfs.vo.organization.DclzTypeVO" id="dclztypeMap">
	<result property="dclzNo" column="DCLZ_NO"/>
	<result property="dclzCode" column="DCLZ_CODE"/>
	<result property="dclzBeginDt" column="DCLZ_BEGIN_DT"/>
	<result property="dclzEndDt" column="DCLZ_END_DT"/>
	<result property="emplNo" column="EMPL_NO"/>
	<result property="bad" column="BAD"/>
	<result property="work" column="WORK"/>
	<result property="vacation" column="VACATION"/>
	<result property="businessTrip" column="BUSINESS_TRIP"/>
	<result property="upperCmmnCode" column="UPPER_CMMN_CODE"/>
</resultMap>

<!-- <resultMap type="kr.or.ddit.sevenfs.vo.CommonCodeVO" id="commonMap">
	<result property="cmmnCodeSn" column="CMMN_CODE_SN"/>
	<result property="cmmnCodeGroup" column="CMMN_CODE_GROUP"/>
	<result property="cmmnCode" column="CMMN_CODE"/>
	<result property="cmmnCodeNm" column="CMMN_CODE_NM"/>
	<result property="cmmnCodeDc" column="CMMN_CODE_DC"/>
	<result property="useYn" column="USE_YN"/>
	<result property="upperCmmnCode" column="UPPER_CMMN_CODE"/>
	<result property="cnt" column="CNT"/>
</resultMap> -->

<!-- 출근시간 등록 -->
<insert id="workBeginInsert" parameterType="kr.or.ddit.sevenfs.vo.organization.DclzTypeVO">
	INSERT INTO dclz_type
           	(empl_no, 
           	 dclz_no
           	 ,dclz_code
           	 ,dclz_begin_dt
           	 ,dclz_end_dt)
    VALUES (#{emplNo}
             ,(TO_CHAR(SYSDATE
             ,'YYYYmmDD'))
             ,#{dclzCode}
             ,SYSTIMESTAMP
             ,NULL)
</insert>

<!-- 퇴근시간 등록 -->
<update id="workEndInsert" parameterType="String">
	UPDATE dclz_type
	SET dclz_end_dt = SYSTIMESTAMP
	WHERE empl_no = #{emplNo}
	AND dclz_no = TO_CHAR(SYSDATE, 'YYYYmmDD')
	AND dclz_code = #{dclzCode}
</update>

<!-- 오늘 등록한 출,퇴근 시간 가져오기 -->
<select id="getTodayWorkTime" parameterType="String" resultType="kr.or.ddit.sevenfs.vo.organization.DclzTypeVO">
	SELECT 
		   TO_CHAR(dclz_begin_dt, 'HH24:MI:SS') as today_work_start_time
           ,TO_CHAR(dclz_end_dt, 'HH24:MI:SS') as today_work_end_time
   	  FROM dclz_type
	 WHERE empl_no = #{emplNo}
 	   AND dclz_code = #{dclzCode}
	   AND dclz_no = TO_CHAR(SYSDATE, 'YYYYmmDD')
</select>

<!-- 선택한 년도의 데이터 가져오기 -->
<select id="getSelectYear" parameterType="kr.or.ddit.sevenfs.vo.organization.DclzTypeVO" resultType="kr.or.ddit.sevenfs.vo.organization.DclzTypeVO">
	SELECT 
		    dt.empl_no
		   ,dt.dclz_no
		   ,dt.dclz_code
		   ,TO_CHAR(dt.dclz_begin_dt, 'HH24:MI:SS') as work_begin_time
		   ,TO_CHAR(dt.dclz_end_dt, 'HH24:MI:SS') as work_end_time
           ,cc.cmmn_code_nm
	  FROM dclz_type dt
      RIGHT OUTER JOIN common_code cc ON dt.dclz_code = cc.cmmn_code
	  WHERE cmmn_code_group='ATTEND'
      AND dt.empl_no = #{emplNo}
      AND (TO_CHAR(dt.dclz_begin_dt, 'YYYY') LIKE #{workBeginDate})
      ORDER BY dt.dclz_no DESC
</select>

<!-- 선택한 년도와 달의 데이터 가져오기 -->
<select id="getSelectMonth" parameterType="kr.or.ddit.sevenfs.vo.organization.DclzTypeVO" resultType="kr.or.ddit.sevenfs.vo.organization.DclzTypeVO">
	SELECT 
		    dt.empl_no
		   ,dt.dclz_no
		   ,dt.dclz_code
		   ,TO_CHAR(dt.dclz_begin_dt, 'HH24:MI:SS') as work_begin_time
		   ,TO_CHAR(dt.dclz_end_dt, 'HH24:MI:SS') as work_end_time
           ,cc.cmmn_code_nm
	  FROM dclz_type dt
      RIGHT OUTER JOIN common_code cc ON dt.dclz_code = cc.cmmn_code
	  WHERE cmmn_code_group='ATTEND'
      AND dt.empl_no = #{emplNo}
      AND (TO_CHAR(dt.dclz_begin_dt, 'YYYY') LIKE #{workBeginDate})
      AND (TO_CHAR(dt.dclz_end_dt, 'mm') LIKE #{workEndDate})
      ORDER BY dt.dclz_no DESC
</select>


</mapper>